name: android-build
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Flutter 3.24.0 (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.24.0"

      - name: Ensure android/ (if missing)
        shell: bash
        run: |
          set -e
          if [ ! -d android ]; then
            flutter create . --platforms=android --project-name=popperscuv5
          fi

      - name: Gradle wrapper 8.2.1
        shell: bash
        run: |
          set -e
          mkdir -p android/gradle/wrapper
          echo "distributionUrl=https://services.gradle.org/distributions/gradle-8.2.1-all.zip" > android/gradle/wrapper/gradle-wrapper.properties

      # === CLAVE: settings.gradle con loader de Flutter y includeBuild al flutter_tools ===
      - name: settings.gradle (Flutter plugin loader + AGP/Kotlin)
        shell: bash
        run: |
          set -e
          FILE="android/settings.gradle"
          echo "pluginManagement {" > "$FILE"
          echo "  repositories {" >> "$FILE"
          echo "    google()" >> "$FILE"
          echo "    mavenCentral()" >> "$FILE"
          echo "    gradlePluginPortal()" >> "$FILE"
          echo "  }" >> "$FILE"
          echo "  def flutterSdkPath = System.getenv('FLUTTER_HOME') ?: System.getenv('FLUTTER_ROOT')" >> "$FILE"
          echo "  if (flutterSdkPath != null) {" >> "$FILE"
          echo "    includeBuild(\"\${flutterSdkPath}/packages/flutter_tools/gradle\")" >> "$FILE"
          echo "  }" >> "$FILE"
          echo "}" >> "$FILE"
          echo "" >> "$FILE"
          echo "plugins {" >> "$FILE"
          echo "  id \"dev.flutter.flutter-plugin-loader\" version \"1.0.0\"" >> "$FILE"
          echo "  id \"com.android.application\" version \"8.1.2\" apply false" >> "$FILE"
          echo "  id \"org.jetbrains.kotlin.android\" version \"1.9.24\" apply false" >> "$FILE"
          echo "}" >> "$FILE"
          echo "include(\":app\")" >> "$FILE"

      # === CLAVE: app/build.gradle aplicando el plugin de Flutter ===
      - name: app/build.gradle (apply Flutter plugin + SDK 35)
        shell: bash
        run: |
          set -e
          APP="android/app/build.gradle"
          : > "$APP"
          {
            echo "plugins {"
            echo "  id \"com.android.application\""
            echo "  id \"org.jetbrains.kotlin.android\""
            echo "  id \"dev.flutter.flutter-gradle-plugin\""   # <â€” plugin de Flutter
            echo "}"
            echo ""
            echo "android {"
            echo "  namespace \"com.example.popperscuv5\""
            echo "  compileSdk 35"
            echo ""
            echo "  defaultConfig {"
            echo "    applicationId \"com.example.popperscuv5\""
            echo "    minSdk 21"
            echo "    targetSdk 35"
            echo "    versionCode 1"
            echo "    versionName \"1.0.0\""
            echo "  }"
            echo ""
            echo "  buildTypes {"
            echo "    release {"
            echo "      minifyEnabled false"
            echo "      proguardFiles getDefaultProguardFile(\"proguard-android-optimize.txt\"), \"proguard-rules.pro\""
            echo "    }"
            echo "  }"
            echo ""
            echo "  compileOptions {"
            echo "    sourceCompatibility JavaVersion.VERSION_17"
            echo "    targetCompatibility JavaVersion.VERSION_17"
            echo "  }"
            echo ""
            echo "  kotlinOptions {"
            echo "    jvmTarget = \"17\""
            echo "  }"
            echo "}"
            echo ""
            echo "dependencies {"
            echo "  implementation \"org.jetbrains.kotlin:kotlin-stdlib:1.9.24\""
            echo "}"
          } >> "$APP"

      - name: AndroidX/Jetifier
        shell: bash
        run: |
          set -e
          echo "android.useAndroidX=true"  >> android/gradle.properties
          echo "android.enableJetifier=true" >> android/gradle.properties

      - name: Build APK (release)
        shell: bash
        run: |
          set -e
          flutter --version
          flutter pub get
          flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk